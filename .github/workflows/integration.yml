name: Integration

on:
  workflow_dispatch:
  schedule:
    # Weekly (Monday 06:00 UTC) full install/build.
    - cron: "0 6 * * 1"

concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unix:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2

      - name: Trust mise config
        run: mise trust --yes

      - name: Install system prerequisites (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ca-certificates \
            curl \
            git \
            libffi-dev \
            libgmp-dev \
            m4 \
            opam \
            pkg-config \
            rsync \
            time \
            unzip

      - name: Install system prerequisites (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install \
            gmp \
            gnu-time \
            libffi \
            make \
            opam \
            pkg-config

      - run: mise run test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2

      - name: Trust mise config
        run: mise trust --yes

      - name: Install system prerequisites (Windows)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            make
            rsync
            time
            unzip
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-gmp
            mingw-w64-x86_64-libffi

      - name: Install OPAM (Windows)
        shell: pwsh
        run: |
          winget --version
          winget install --id OCaml.opam --exact --accept-source-agreements --accept-package-agreements

          # Refresh PATH from registry (winget updates User/Machine PATH, but this process doesn't automatically reload it).
          $machinePath = [System.Environment]::GetEnvironmentVariable("Path", "Machine")
          $userPath = [System.Environment]::GetEnvironmentVariable("Path", "User")
          $env:Path = "$machinePath;$userPath"

          $opam = Get-Command opam -ErrorAction SilentlyContinue
          if (-not $opam) {
            Write-Error "opam not found on PATH after winget install"
            exit 1
          }

          $opamDir = Split-Path -Parent $opam.Path
          "OPAM found at: $($opam.Path)"
          Add-Content -Path $env:GITHUB_PATH -Value $opamDir

      - run: mise run test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
