name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2

      - name: Trust mise config
        run: mise trust --yes

      - name: Install system prerequisites (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ca-certificates \
            curl \
            git \
            libffi-dev \
            libgmp-dev \
            m4 \
            opam \
            pkg-config \
            rsync \
            time \
            unzip

      - name: Install system prerequisites (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install \
            gmp \
            gnu-time \
            libffi \
            make \
            opam \
            pkg-config

      - name: Run CI (Linux/macOS)
        if: runner.os != 'Windows'
        run: mise run ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run smoke test (Windows)
        if: runner.os == 'Windows'
        run: mise run test-smoke
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
