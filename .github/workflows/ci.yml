name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2

      - name: Trust mise config
        run: mise trust --yes

      - name: Export mise paths (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $miseRoot = Join-Path $env:LOCALAPPDATA "mise"
          if (-not (Test-Path $miseRoot)) {
            Write-Error "mise directory not found at $miseRoot"
            exit 1
          }
          "MISE_WIN_DIR=$miseRoot" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install system prerequisites (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ca-certificates \
            curl \
            git \
            libffi-dev \
            libgmp-dev \
            m4 \
            opam \
            pkg-config \
            rsync \
            time \
            unzip

      - name: Install system prerequisites (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install \
            gmp \
            gnu-time \
            libffi \
            make \
            opam \
            pkg-config

      - name: Install system prerequisites (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false

      - name: Export MSYS2 shell for mise (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          MSYS2_ROOT_WIN="$(cygpath -w / | tr '\\' '/')"
          echo "MISE_WINDOWS_DEFAULT_INLINE_SHELL_ARGS=${MSYS2_ROOT_WIN}/usr/bin/bash.exe -lc" >> "$GITHUB_ENV"
          echo "MISE_WINDOWS_DEFAULT_FILE_SHELL_ARGS=${MSYS2_ROOT_WIN}/usr/bin/bash.exe --norc -eo pipefail -o igncr" >> "$GITHUB_ENV"
          echo "MSYS2_ROOT_WIN=${MSYS2_ROOT_WIN}" >> "$GITHUB_ENV"

      - name: Configure MSYS2 mirrors and install packages
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euxo pipefail

          cat > /etc/pacman.d/mirrorlist.mingw <<'EOF'
          Server = https://mirror.msys2.org/mingw/$repo/
          Server = https://repo.msys2.org/mingw/$repo/
          EOF

          cat > /etc/pacman.d/mirrorlist.msys <<'EOF'
          Server = https://mirror.msys2.org/msys/$arch/
          Server = https://repo.msys2.org/msys/$arch/
          EOF

          retry() {
            local attempt=1
            local max=3
            while true; do
              if "$@"; then
                return 0
              fi
              if [ "$attempt" -ge "$max" ]; then
                return 1
              fi
              echo "pacman failed, retrying ($attempt/$max)..."
              sleep $((10 * attempt))
              attempt=$((attempt + 1))
            done
          }

          retry pacman --noconfirm -Syuu --overwrite "*"
          retry pacman --noconfirm -Syuu --overwrite "*"

          retry pacman --noconfirm -S --needed --overwrite "*" \
            git \
            diffutils \
            patch \
            make \
            rsync \
            time \
            unzip \
            mingw-w64-x86_64-toolchain \
            mingw-w64-x86_64-make \
            mingw-w64-x86_64-pkgconf \
            mingw-w64-x86_64-gmp \
            mingw-w64-x86_64-libffi

      - name: Install OPAM (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          winget --version
          winget install --id OCaml.opam --exact --accept-source-agreements --accept-package-agreements

          # Refresh PATH from registry (winget updates User/Machine PATH, but this process doesn't automatically reload it).
          $machinePath = [System.Environment]::GetEnvironmentVariable("Path", "Machine")
          $userPath = [System.Environment]::GetEnvironmentVariable("Path", "User")
          $env:Path = "$machinePath;$userPath"

          $opam = Get-Command opam -ErrorAction SilentlyContinue
          if (-not $opam) {
            Write-Error "opam not found on PATH after winget install"
            exit 1
          }

          $opamDir = Split-Path -Parent $opam.Path
          "OPAM found at: $($opam.Path)"
          Add-Content -Path $env:GITHUB_PATH -Value $opamDir
          "OPAM_WIN_DIR=$opamDir" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Preflight (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        env:
          MISE_USE_FILE_SHELL_FOR_EXECUTABLE_TASKS: "true"
          PKG_CONFIG_PATH: "/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"
        run: |
          set -euxo pipefail

          if [ -n "${MISE_WIN_DIR:-}" ]; then
            MISE_WIN_DIR_POSIX="$(cygpath -u "$MISE_WIN_DIR")"
            export PATH="$MISE_WIN_DIR_POSIX/shims:$MISE_WIN_DIR_POSIX/bin:$PATH"
            export MISE_EXE="$MISE_WIN_DIR_POSIX/bin/mise.exe"
          fi

          if [ -n "${OPAM_WIN_DIR:-}" ]; then
            export PATH="$(cygpath -u "$OPAM_WIN_DIR"):$PATH"
          fi

          echo "=== Shell identity ==="
          echo "SHELL=$SHELL"
          echo "MSYSTEM=$MSYSTEM"
          echo "PATH=$PATH"
          type -a bash || true

          echo "=== Tool resolution (bash) ==="
          type -a pkg-config || true
          type -a pkgconf || true
          type -a gcc || true
          type -a make || true
          type -a opam || true
          type -a mise || true

          echo "=== pkg-config sanity ==="
          pkg-config --version || true
          pkg-config --variable pc_path pkg-config || true

          echo "=== pkg-config probes ==="
          pkg-config --exists gmp && echo "gmp: ok" || (echo "gmp: FAIL"; pkg-config --print-errors --exists gmp || true)
          pkg-config --exists libffi && echo "libffi: ok" || (echo "libffi: FAIL"; pkg-config --print-errors --exists libffi || true)

          echo "=== cmd.exe resolution (what Lua os.execute would hit) ==="
          cmd.exe /c "where bash" || true
          cmd.exe /c "where pkg-config" || true
          cmd.exe /c "where pkgconf" || true

      - name: Run lint (Linux/macOS)
        if: runner.os != 'Windows'
        run: mise run lint
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run full test (Linux/macOS)
        if: runner.os != 'Windows'
        run: mise run test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run full test (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        env:
          MISE_USE_FILE_SHELL_FOR_EXECUTABLE_TASKS: "true"
          PKG_CONFIG_PATH: "/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"
          MISE_FSTAR_STACK_DEBUG: "1"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          if [ -n "${MISE_WIN_DIR:-}" ]; then
            MISE_WIN_DIR_POSIX="$(cygpath -u "$MISE_WIN_DIR")"
            export PATH="$MISE_WIN_DIR_POSIX/shims:$MISE_WIN_DIR_POSIX/bin:$PATH"
            export MISE_EXE="$MISE_WIN_DIR_POSIX/bin/mise.exe"
          fi
          if [ -n "${OPAM_WIN_DIR:-}" ]; then
            export PATH="$(cygpath -u "$OPAM_WIN_DIR"):$PATH"
          fi
          bash mise-tasks/test
