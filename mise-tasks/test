#!/usr/bin/env bash
#MISE description="Run plugin tests - install and execute tool"
set -euo pipefail

# Run from repo root.
# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_DIR="$(dirname "$SCRIPT_DIR")"

default_version="$(awk -F'\"' '/^M[.]LATEST_STACK =/ {print $2; exit}' "$PLUGIN_DIR/lib/versions.lua")"
VERSION="${FSTAR_STACK_TEST_VERSION:-$default_version}"

if [[ -z "${VERSION:-}" ]]; then
    echo "ERROR: Could not determine stack version to test."
    echo "Set FSTAR_STACK_TEST_VERSION or ensure lib/versions.lua defines M.LATEST_STACK."
    exit 1
fi

echo "=== Linking plugin for testing ==="
mise plugin link --force fstar-stack "$PLUGIN_DIR"

echo ""
echo "=== Installing fstar-stack@${VERSION} (includes KaRaMeL by default) ==="
# Reinstall to test the plugin (--force to reinstall if already installed)
mise install "fstar-stack@${VERSION}" --force

echo ""
FSTAR_STACK_TEST_VERSION="$VERSION" mise run verify

echo ""
is_windows=0
if [[ "${OS:-}" == "Windows_NT" ]]; then
    is_windows=1
fi
case "$(uname -s 2>/dev/null || true)" in
    MINGW*|MSYS*|CYGWIN*)
        is_windows=1
        ;;
esac

if [[ "$is_windows" -eq 1 ]]; then
    echo "=== Test 5: KaRaMeL required by default (skipped on Windows) ==="
else
    echo "=== Test 5: KaRaMeL required by default ==="
    mise exec "fstar-stack@${VERSION}" -- Karamel.exe -version
    krml_home="$(mise exec "fstar-stack@${VERSION}" -- printenv KRML_HOME 2>/dev/null || true)"
    if [[ -n "${krml_home:-}" ]]; then
        echo "✓ KRML_HOME is set: $krml_home"
    else
        echo "✗ KRML_HOME is not set (KaRaMeL build likely failed)"
        exit 1
    fi
fi

echo ""
echo "=== All tests passed ==="
