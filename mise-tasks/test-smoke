#!/usr/bin/env bash
#MISE description="Smoke test plugin (full install)"
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_DIR="$(dirname "$SCRIPT_DIR")"

default_version="$(awk -F'\"' '/^M[.]LATEST_STACK =/ {print $2; exit}' "$PLUGIN_DIR/lib/versions.lua")"
VERSION="${FSTAR_STACK_TEST_VERSION:-$default_version}"

if [[ -z "${VERSION:-}" ]]; then
    echo "ERROR: Could not determine stack version to test."
    echo "Set FSTAR_STACK_TEST_VERSION or ensure lib/versions.lua defines M.LATEST_STACK."
    exit 1
fi

echo "=== Linking plugin for testing ==="
mise plugin link --force fstar-stack "$PLUGIN_DIR"

echo ""
echo "=== Installing fstar-stack@${VERSION} ==="
mise install "fstar-stack@${VERSION}" --force

FSTAR_STACK_TEST_VERSION="$VERSION" mise run verify
